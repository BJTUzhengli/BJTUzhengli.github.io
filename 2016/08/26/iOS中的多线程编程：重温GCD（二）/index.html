<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="引言此文是iOS中的多线程编程：重温GCD（一）的第二部分。将会辅以一定的例子讲解一些更深层次的API使用及注意事项。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS中的多线程编程：重温GCD（二）.md">
<meta property="og:url" content="http://yoursite.com/2016/08/26/iOS中的多线程编程：重温GCD（二）/index.html">
<meta property="og:site_name" content="🐰BiuBiuBiu~">
<meta property="og:description" content="引言此文是iOS中的多线程编程：重温GCD（一）的第二部分。将会辅以一定的例子讲解一些更深层次的API使用及注意事项。">
<meta property="og:image" content="http://i2.buimg.com/572363/3af4576fb2897c06.png">
<meta property="og:updated_time" content="2016-08-26T11:35:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS中的多线程编程：重温GCD（二）.md">
<meta name="twitter:description" content="引言此文是iOS中的多线程编程：重温GCD（一）的第二部分。将会辅以一定的例子讲解一些更深层次的API使用及注意事项。">
<meta name="twitter:image" content="http://i2.buimg.com/572363/3af4576fb2897c06.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Zheng Li'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/08/26/iOS中的多线程编程：重温GCD（二）/"/>

  <title> iOS中的多线程编程：重温GCD（二）.md | 🐰BiuBiuBiu~ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">🐰BiuBiuBiu~</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">记录自己学习的点点滴滴</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS中的多线程编程：重温GCD（二）.md
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-26T19:34:26+08:00" content="2016-08-26">
              2016-08-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/26/iOS中的多线程编程：重温GCD（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/26/iOS中的多线程编程：重温GCD（二）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/08/26/iOS中的多线程编程：重温GCD（二）/" class="leancloud_visitors" data-flag-title="iOS中的多线程编程：重温GCD（二）.md">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>此文是<a href="http://objc.in/2016/08/24/iOS%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%EF%BC%9A%E9%87%8D%E6%B8%A9GCD%EF%BC%88%E4%B8%80%EF%BC%89/" target="_blank" rel="external">iOS中的多线程编程：重温GCD（一）</a>的第二部分。将会辅以一定的例子讲解一些更深层次的<code>API</code>使用及注意事项。</p>
<a id="more"></a>
<h2 id="栅栏-Using-Barriers"><a href="#栅栏-Using-Barriers" class="headerlink" title="栅栏 | Using Barriers"></a>栅栏 | Using Barriers</h2><h3 id="使用Barrier构建一个安全的读写操作"><a href="#使用Barrier构建一个安全的读写操作" class="headerlink" title="使用Barrier构建一个安全的读写操作"></a>使用<code>Barrier</code>构建一个安全的读写操作</h3><p>在<a href="http://objc.in/2016/08/24/iOS%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%EF%BC%9A%E9%87%8D%E6%B8%A9GCD%EF%BC%88%E4%B8%80%EF%BC%89/" target="_blank" rel="external">上篇文章</a>中，我们最后提到了如何利用<code>GCD</code>创建线程安全的单例。但这其实是远远不够的。考虑这样一个问题：</p>
<p>如果我们的单粒中有这样的可变属性</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableArray</span> *array;`</div></pre></td></tr></table></figure>
<p>我们了解，在<code>objc</code>中，apple明确告诉我们这样的可变集合都<strong>不是线程安全</strong>的。这意味着，如果我们的单粒在多个线程中被读写，很容易就发生数据混乱的问题！</p>
<p><code>dispatch barrier</code>可以很好的解决这个问题！</p>
<p>根据apple官方文档：</p>
<blockquote>
<p>A dispatch barrier allows you to create a synchronization point within a concurrent dispatch queue. When it encounters a barrier, a concurrent queue delays the execution of the barrier block (or any further blocks) until all blocks submitted before the barrier finish executing. At that point, the barrier block executes by itself. Upon completion, the queue resumes its normal execution behavior.</p>
</blockquote>
<p>简单翻译下，可见<code>dispatch barrier</code>允许我们在一个并发队列中创建一个<strong>同步</strong>点，你也可以把它理解为一个任务(<code>block</code>)，当队列中的任务按序派发到这里时，并发队列会停下等待<code>barrier</code>点前面的所有任务执行完毕，接着执行<code>barrier block</code>。等<code>barrier block</code>执行完毕后继续执行后面的任务:</p>
<p><img src="http://i2.buimg.com/572363/3af4576fb2897c06.png" alt="barrier"></p>
<p>试想一下，如果我们在两个线程同时在操作这个数组，如果两个线程都在同时读取，那不会引起问题。如果一个线程中在读取，同时另外一个线程中在写入，就会引起线程不安全的问题！</p>
<p>所以我们应该不把这个属性暴露在外部，使得外部不能直接写入，而是提供给外部一些方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)add:(<span class="keyword">id</span>)object;</div><div class="line">- (<span class="keyword">void</span>)remove:(<span class="keyword">id</span>)object;</div></pre></td></tr></table></figure>
<p>然后，我们在内部利用<code>barrier</code>进行安全的写入：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)add:(<span class="keyword">id</span>)object&#123;</div><div class="line">	<span class="keyword">if</span>(!object) <span class="keyword">return</span>;</div><div class="line">	<span class="comment">//保证写入时，不会被队列中的异步操作"打扰"</span></div><div class="line">	dispatch_barrier_async(<span class="keyword">self</span>.concurrentQueue, ^&#123; </div><div class="line">	[<span class="keyword">self</span>.array addObject:object];</div><div class="line">	</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们就保证了在操作单例中数组的过程中，不会发生任何异步行为，也就保证了线程安全！</p>
<p>另外需要注意得地方是，我们在上述代码段里使用了<code>self.concurrentQueue</code>为什么我们会使用<code>self.concurrentQueue</code>?</p>
<p>首先要说明的是，<code>self.concurrentQueue</code>是一个自定义的并发队列，它的创建方式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">self</span>.concurrentQueue = dispatch_queue_create(<span class="string">"com.selander.GooglyPuff.photoQueue"</span>,</div><div class="line">                                                    DISPATCH_QUEUE_CONCURRENT);</div></pre></td></tr></table></figure>
<p>我们会将单粒中的读操作也放在这个队列里：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSArray</span> *) array</div><div class="line">&#123;</div><div class="line">    __block <span class="built_in">NSArray</span> *array; </div><div class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.concurrentQueue, ^&#123; </div><div class="line">        array = [<span class="built_in">NSArray</span> arrayWithArray:_photosArray]; </div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> array;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，才能保证在写操作时候拦住前面的读操作，因为它们都在用一个队列中。当然，<strong>这个地方必须使用<code>dispathc_sync</code>函数</strong>，如果异步调用意味着函数不会立即返回。那么在外部使用的得到的数组时就可能会出问题,比如:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSMutableArray</span> *)array&#123;</div><div class="line">    </div><div class="line">     __block <span class="built_in">NSMutableArray</span> *tmpArray = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.concurrentQueue, ^&#123;</div><div class="line">        tmpArray = [_array <span class="keyword">copy</span>];<span class="comment">//注意这个地方可能在返回之前还没有调用！</span></div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> tmpArray;<span class="comment">//tmpArray可能为nil！</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="barrier的API"><a href="#barrier的API" class="headerlink" title="barrier的API"></a><code>barrier</code>的<code>API</code></h3><p><code>barrier</code>是个很有用的特性，在apple的官方文档中，有列出了下列函数供我们使用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> dispatch_barrier_async( <span class="built_in">dispatch_queue_t</span> queue, </div><div class="line">									dispatch_block_t block);</div><div class="line"></div><div class="line"><span class="keyword">void</span> dispatch_barrier_async_f( <span class="built_in">dispatch_queue_t</span> queue, </div><div class="line">									<span class="keyword">void</span>* context, </div><div class="line">									dispatch_function_t work);</div><div class="line"></div><div class="line"><span class="keyword">void</span> dispatch_barrier_sync( <span class="built_in">dispatch_queue_t</span> queue, </div><div class="line">								    dispatch_block_t block);</div><div class="line"></div><div class="line"><span class="keyword">void</span> dispatch_barrier_sync_f( <span class="built_in">dispatch_queue_t</span> queue, </div><div class="line">									<span class="keyword">void</span>* context, </div><div class="line">									dispatch_function_t work);</div></pre></td></tr></table></figure>
<p>其实还是很有规律的😄：<code>async</code>与<code>sync</code>相对表示同步or异步、<code>async_f</code>与<code>sync</code>相对表示执行的是<code>block</code>或者<code>dispatch_function_t</code>对象。</p>
<p>由于篇幅有限，在这里就不在解释了。只给出结论: </p>
<ol>
<li><p>无论是<code>dispatch_barrier_sync</code>or <code>dispatch_barrier_async</code>函数，最终都会调用到<code>dispatch_barrier_sync_f</code>or<code>dispatch_barrier_async_f</code>。</p>
</li>
<li><p><code>dispatch_barrier_sync_f</code>函数中的<code>void* context</code>参数其实就是我们传给<code>dispatch_barrier_sync</code>函数中的<code>block</code>对象。而<code>dispatch_function_t work</code>参数是<code>block</code>对象里的函数指针(懂的人自然懂😄)。</p>
</li>
</ol>
<h3 id="barrier使用建议"><a href="#barrier使用建议" class="headerlink" title="barrier使用建议"></a><code>barrier</code>使用建议</h3><p>要理解<code>barrier</code>拦住的是队列，也就是说，<code>barrier</code>针对的队列。所以不难给出以下建议：</p>
<ol>
<li>不要在自定义串行队列中使用：一个很坏的选择，障碍不会有任何帮助，因为不管怎样，一个串行队列一次都只执行一个操作。</li>
<li>不要在全局并发队列中使用：要小心，这可能不是最好的主意，因为其它系统可能在使用队列而且你不能垄断它们只为你自己的目的。</li>
<li>最好在自定义并发队列中使用：这对于原子或临界区代码来说是极佳的选择。任何你在设置或实例化的需要线程安全的事物都是使用障碍的最佳候选。</li>
</ol>
<h3 id="barrier部分小结"><a href="#barrier部分小结" class="headerlink" title="barrier部分小结"></a><code>barrier</code>部分小结</h3><p><strong>todo 这里之后给出源码解读文章地址</strong>如果想要了解更多关于<code>barrier</code>的实现细节，可以查看我的这篇。当然你也可以自己下载<code>GCD</code>源码阅读：<a href="http://opensource.apple.com/tarballs/libdispatch/libdispatch-442.1.4.tar.gz" target="_blank" rel="external">libdispatch</a>。</p>
<h2 id="调度组-Dispatch-Groups"><a href="#调度组-Dispatch-Groups" class="headerlink" title="调度组 | Dispatch Groups"></a>调度组 | Dispatch Groups</h2>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>请杯咖啡喝？</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://i1.buimg.com/572363/b21593e5f65ea204.jpg" alt="Zheng Li WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://i1.buimg.com/572363/7caac38df4844f66.jpg" alt="Zheng Li Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/24/iOS中的多线程编程：重温GCD（一）/" rel="next" title="iOS中的多线程编程：重温GCD（一）">
                <i class="fa fa-chevron-left"></i> iOS中的多线程编程：重温GCD（一）
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/08/26/iOS中的多线程编程：重温GCD（二）/"
           data-title="iOS中的多线程编程：重温GCD（二）.md" data-url="http://yoursite.com/2016/08/26/iOS中的多线程编程：重温GCD（二）/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://tva3.sinaimg.cn/crop.0.0.511.511.180/006pqpL6jw8f4z97xky5nj30e70e8aai.jpg"
               alt="Zheng Li" />
          <p class="site-author-name" itemprop="name">Zheng Li</p>
          <p class="site-description motion-element" itemprop="description">iOS开发菜鸡，努力提高自我中。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://yulingtianxia.com/" title="yulingtianxia" target="_blank">yulingtianxia</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://kyxu.tech/" title="kyXu" target="_blank">kyXu</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#栅栏-Using-Barriers"><span class="nav-number">2.</span> <span class="nav-text">栅栏 | Using Barriers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Barrier构建一个安全的读写操作"><span class="nav-number">2.1.</span> <span class="nav-text">使用Barrier构建一个安全的读写操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#barrier的API"><span class="nav-number">2.2.</span> <span class="nav-text">barrier的API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#barrier使用建议"><span class="nav-number">2.3.</span> <span class="nav-text">barrier使用建议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#barrier部分小结"><span class="nav-number">2.4.</span> <span class="nav-text">barrier部分小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调度组-Dispatch-Groups"><span class="nav-number">3.</span> <span class="nav-text">调度组 | Dispatch Groups</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zheng Li</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"BJTUzhengli"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("28Bi52ufQCnrlpfv4vbx8JEG-gzGzoHsz", "1cAbB9JCSijqEURfv3Pa9uYd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
