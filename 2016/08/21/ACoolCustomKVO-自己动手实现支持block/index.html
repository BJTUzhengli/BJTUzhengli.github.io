<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="å‰è¨€ä»¥å‰æœ‰çœ‹è¿‡å…³äºKVOå®ç°æœºåˆ¶æ–¹é¢çš„å†…å®¹ï¼Œé‚£ä¸ªæ—¶å€™è‡ªå·±è¿˜å¯¹ç±»å¯¹è±¡è¿™ä¸ªæ¦‚å¿µç†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¯¼è‡´è‡ªå·±å¯¹KVOçš„ç†è§£ä¹Ÿæ˜¯å›«å›µåæ£,åŠ ä¹‹è¦æƒ³ç†è§£å¥½KVOï¼Œä¹Ÿéœ€è¦æœ‰ä¸€å®šçš„runtimeçŸ¥è¯†çš„åŸºç¡€ã€‚å†æ¶è¡¥äº†runtimeæ–¹é¢çš„çŸ¥è¯†åï¼Œå€ŸåŠ©è¿™ç¯‡åšå†å®¢æ¸©ä¹ ä¸‹å…³äºKVOçš„å†…å®¹å§ã€‚
psï¼šæœ¬æ–‡ä¸­å…³äºruntimeåŠç±»å¯¹è±¡ç­‰çŸ¥è¯†ä¸åœ¨å™è¿°ï¼Œè‹¥å¯¹æ­¤ä¸äº†è§£ï¼Œå¯ä»¥æˆ³ğŸ‘‡
èŠèŠruntime
æ·±å…¥ç†è§£objcä¸­çš„å¯¹è±¡ä¸ç±»">
<meta property="og:type" content="article">
<meta property="og:title" content="ACoolCustomKVO--è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblockå›è°ƒçš„KVO">
<meta property="og:url" content="http://yoursite.com/2016/08/21/ACoolCustomKVO-è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblock/index.html">
<meta property="og:site_name" content="TèŒèŒBiuBiuBiu~">
<meta property="og:description" content="å‰è¨€ä»¥å‰æœ‰çœ‹è¿‡å…³äºKVOå®ç°æœºåˆ¶æ–¹é¢çš„å†…å®¹ï¼Œé‚£ä¸ªæ—¶å€™è‡ªå·±è¿˜å¯¹ç±»å¯¹è±¡è¿™ä¸ªæ¦‚å¿µç†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¯¼è‡´è‡ªå·±å¯¹KVOçš„ç†è§£ä¹Ÿæ˜¯å›«å›µåæ£,åŠ ä¹‹è¦æƒ³ç†è§£å¥½KVOï¼Œä¹Ÿéœ€è¦æœ‰ä¸€å®šçš„runtimeçŸ¥è¯†çš„åŸºç¡€ã€‚å†æ¶è¡¥äº†runtimeæ–¹é¢çš„çŸ¥è¯†åï¼Œå€ŸåŠ©è¿™ç¯‡åšå†å®¢æ¸©ä¹ ä¸‹å…³äºKVOçš„å†…å®¹å§ã€‚
psï¼šæœ¬æ–‡ä¸­å…³äºruntimeåŠç±»å¯¹è±¡ç­‰çŸ¥è¯†ä¸åœ¨å™è¿°ï¼Œè‹¥å¯¹æ­¤ä¸äº†è§£ï¼Œå¯ä»¥æˆ³ğŸ‘‡
èŠèŠruntime
æ·±å…¥ç†è§£objcä¸­çš„å¯¹è±¡ä¸ç±»">
<meta property="og:image" content="http://i4.buimg.com/572363/591dff9c944a7298t.jpg">
<meta property="og:image" content="http://i4.buimg.com/572363/24a6b39337205201t.jpg">
<meta property="og:updated_time" content="2016-08-21T11:24:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ACoolCustomKVO--è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblockå›è°ƒçš„KVO">
<meta name="twitter:description" content="å‰è¨€ä»¥å‰æœ‰çœ‹è¿‡å…³äºKVOå®ç°æœºåˆ¶æ–¹é¢çš„å†…å®¹ï¼Œé‚£ä¸ªæ—¶å€™è‡ªå·±è¿˜å¯¹ç±»å¯¹è±¡è¿™ä¸ªæ¦‚å¿µç†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¯¼è‡´è‡ªå·±å¯¹KVOçš„ç†è§£ä¹Ÿæ˜¯å›«å›µåæ£,åŠ ä¹‹è¦æƒ³ç†è§£å¥½KVOï¼Œä¹Ÿéœ€è¦æœ‰ä¸€å®šçš„runtimeçŸ¥è¯†çš„åŸºç¡€ã€‚å†æ¶è¡¥äº†runtimeæ–¹é¢çš„çŸ¥è¯†åï¼Œå€ŸåŠ©è¿™ç¯‡åšå†å®¢æ¸©ä¹ ä¸‹å…³äºKVOçš„å†…å®¹å§ã€‚
psï¼šæœ¬æ–‡ä¸­å…³äºruntimeåŠç±»å¯¹è±¡ç­‰çŸ¥è¯†ä¸åœ¨å™è¿°ï¼Œè‹¥å¯¹æ­¤ä¸äº†è§£ï¼Œå¯ä»¥æˆ³ğŸ‘‡
èŠèŠruntime
æ·±å…¥ç†è§£objcä¸­çš„å¯¹è±¡ä¸ç±»">
<meta name="twitter:image" content="http://i4.buimg.com/572363/591dff9c944a7298t.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/08/21/ACoolCustomKVO-è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblock/"/>

  <title> ACoolCustomKVO--è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblockå›è°ƒçš„KVO | TèŒèŒBiuBiuBiu~ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">TèŒèŒBiuBiuBiu~</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">è®°å½•è‡ªå·±å­¦ä¹ çš„ç‚¹ç‚¹æ»´æ»´</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            å…¬ç›Š404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                ACoolCustomKVO--è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblockå›è°ƒçš„KVO
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-21T19:20:01+08:00" content="2016-08-21">
              2016-08-21
            </time>
          </span>

          

          
            
          

          

          
          
             <span id="/2016/08/21/ACoolCustomKVO-è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblock/" class="leancloud_visitors" data-flag-title="ACoolCustomKVO--è‡ªå·±åŠ¨æ‰‹å®ç°æ”¯æŒblockå›è°ƒçš„KVO">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»¥å‰æœ‰çœ‹è¿‡å…³äº<code>KVO</code>å®ç°æœºåˆ¶æ–¹é¢çš„å†…å®¹ï¼Œé‚£ä¸ªæ—¶å€™è‡ªå·±è¿˜å¯¹ç±»å¯¹è±¡è¿™ä¸ªæ¦‚å¿µç†è§£çš„ä¸å¤Ÿæ·±å…¥ï¼Œå¯¼è‡´è‡ªå·±å¯¹KVOçš„ç†è§£ä¹Ÿæ˜¯å›«å›µåæ£,åŠ ä¹‹è¦æƒ³ç†è§£å¥½<code>KVO</code>ï¼Œä¹Ÿéœ€è¦æœ‰ä¸€å®šçš„<code>runtime</code>çŸ¥è¯†çš„åŸºç¡€ã€‚å†æ¶è¡¥äº†<code>runtime</code>æ–¹é¢çš„çŸ¥è¯†åï¼Œå€ŸåŠ©è¿™ç¯‡åšå†å®¢æ¸©ä¹ ä¸‹å…³äº<code>KVO</code>çš„å†…å®¹å§ã€‚</p>
<p>psï¼šæœ¬æ–‡ä¸­å…³äº<code>runtime</code>åŠç±»å¯¹è±¡ç­‰çŸ¥è¯†ä¸åœ¨å™è¿°ï¼Œè‹¥å¯¹æ­¤ä¸äº†è§£ï¼Œå¯ä»¥æˆ³ğŸ‘‡</p>
<p><a href="https://bjtuzhengli.github.io/2016/08/21/%E8%81%8A%E8%81%8Aruntime%E9%82%A3%E4%BA%9B%E4%BA%8B/" target="_blank" rel="external">èŠèŠruntime</a></p>
<p><a href="https://bjtuzhengli.github.io/2016/08/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3objc%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E4%B8%8E%E7%B1%BB/" target="_blank" rel="external">æ·±å…¥ç†è§£objcä¸­çš„å¯¹è±¡ä¸ç±»</a></p>
<a id="more"></a>
<h2 id="KVO-Key-Value-observingï¼‰"><a href="#KVO-Key-Value-observingï¼‰" class="headerlink" title="KVO(Key-Value observingï¼‰"></a>KVO(Key-Value observingï¼‰</h2><p>appleå®˜æ–¹æ–‡æ¡£ğŸ‘‡ï¼š</p>
<blockquote>
<p>The NSKeyValueObserving (KVO) informal protocol defines a mechanism that allows objects to be notified of changes to the specified properties of other objects.</p>
</blockquote>
<p>å¯è§è‹¹æœå°†<code>KVO</code>è¿™ç§æœºåˆ¶ç§°ä¸º<code>NSObject</code>çš„<code>protocol</code>ã€‚è¿™ä¸ª<code>protocol</code>æä¾›äº†ä¸€ç§æœºåˆ¶ï¼šå…è®¸ä¸€ä¸ªå¯¹è±¡æ¥æ”¶åˆ°å¦ä¸€ä¸ªå¯¹è±¡çš„specifed properties`è¢«æ”¹å˜æ—¶çš„é€šçŸ¥ã€‚</p>
<h2 id="KVOå®ç°åŸç†"><a href="#KVOå®ç°åŸç†" class="headerlink" title="KVOå®ç°åŸç†"></a>KVOå®ç°åŸç†</h2><p>appleå®˜æ–¹æ–‡æ¡£ï¼šï¼ˆ<code>Key-Value Observing Implementation Details</code>ï¼‰</p>
<blockquote>
<p>Automatic key-value observing is implemented using a technique called <code>isa-swizzling</code>.</p>
<p>The isa pointer, as the name suggests, points to the objectâ€™s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
</blockquote>
<p>éå¸¸ç²¾ç®€ï¼Œæœ‰ç”¨çš„ä¿¡æ¯åªæœ‰ï¼šè¢«è§‚å¯Ÿçš„ç±»çš„<code>isa</code>æŒ‡é’ˆä¼šæŒ‡å‘ä¸€ä¸ª<code>intermediate class</code>ã€‚é¡ºå¸¦åœ¨æ–‡ç« æœ«å°¾æ¸©é¦¨åœ°æç¤ºäº†ä¸‹ï¼š</p>
<blockquote>
<p>You should <strong>never</strong> rely on the <code>isa</code> pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>
<p>å—¯ï¼Œè°¢è°¢çˆ¸çˆ¸ğŸ˜·</p>
<p>åœ¨ä¹‹å‰<a href="https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html" target="_blank" rel="external">å¤§ç¥Mike Ashçš„åšå®¢</a>ä¸­ï¼Œå°±æ¢è®¨è¿‡appleå…³äº<code>KVO</code>çš„å…·ä½“å®ç°æ­¥éª¤ï¼Œåœ¨æ­¤åªæ˜¯ç®€å•æ¦‚æ‹¬ä¸‹ï¼š</p>
<p>åœ¨ç›‘å¬äº†æŸä¸ªå¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶ï¼Œappleä¼šåˆ›å»ºä¸€ä¸ªç»§æ‰¿è¯¥è¢«ç›‘å¬çš„ç±»çš„å¯¹è±¡ã€‚å¹¶é‡å†™äº†æ­¤ç±»çš„<code>setter</code>æ–¹æ³•ã€‚åœ¨çœŸæ­£çš„<code>setter</code>çš„å‰åéƒ½ä¼šå‘é€é€šçŸ¥ã€‚æœ‰è¶£çš„æ˜¯ï¼Œè¿™ä¸ªè¢«ç›‘å¬çš„å¯¹è±¡ä¸ä»…ä¼šæŠŠè‡ªå·±çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªä¸­é—´ç±»ï¼Œè€Œä¸”appleè¿˜ä¼šå¤å†™è¿™ä¸ªä¸­é—´ç±»çš„ <code>- class</code>æ–¹æ³•ï¼Œä¼å›¾æ¬ºéª—æˆ‘ä»¬è¿™ä¸ªç±»æ²¡æœ‰è¢«æ”¹å˜ã€‚ã€‚ã€‚ğŸ˜“</p>
<p>ä¸Šä¸ªå›¾è¯´æ˜ä¸‹ï¼š</p>
<blockquote>
<p>åœ¨ç›‘å¬ä¹‹å‰ï¼Œå¯¹è±¡åŠç±»çš„å¸ƒå±€å¦‚ä¸‹</p>
</blockquote>
<p><img src="http://i4.buimg.com/572363/591dff9c944a7298t.jpg" alt="ç›‘å¬å‰å¯¹è±¡å¸ƒå±€"></p>
<blockquote>
<p>ç›‘å¬ä¹‹åï¼Œå¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘äº†æ–°çš„ç±»å¯¹è±¡ã€‚æ­¤ç±»å¯¹è±¡ç»§æ‰¿è‡ªåŸå§‹ç±»å¯¹è±¡ã€‚å¹¶ä¸”åœ¨ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•è¡¨ä¸­å¯¹æ–¹æ³•åšäº†ä¸€äº›ç›¸åº”çš„ä¿®æ”¹ï¼Œæ¯”å¦‚é‡å†™äº†<code>setter</code>æ–¹æ³•å¹¶å‘é€é€šçŸ¥ã€é‡å†™è€Œ<code>class</code>æ–¹æ³•ä½¿å…¶è¿”å›<code>originalClass</code>ï¼š</p>
</blockquote>
<p><img src="http://i4.buimg.com/572363/24a6b39337205201t.jpg" alt="ç›‘å¬åå¯¹è±¡å¸ƒå±€"></p>
<p>åªæœ‰åœ¨ç†è§£äº†ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæ‰èƒ½æ¸…æ™°åœ°äº†è§£<code>KVO</code>çš„çœŸæ­£å®ç°æœºåˆ¶ã€‚æ­£å¼ç”±äºè¿™ç§ç‰¹æ®Šå¤„ç†æ–¹æ³•ï¼Œæ‰èƒ½ä½¿æˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶æ— éœ€æ·»åŠ ä»»ä½•ä»£ç å³å¯ç›‘å¬ä»»ä½•å¯¹è±¡çš„å±æ€§æ”¹å˜~</p>
<h2 id="è‡ªå·±åŠ¨æ‰‹å®ç°KVO"><a href="#è‡ªå·±åŠ¨æ‰‹å®ç°KVO" class="headerlink" title="è‡ªå·±åŠ¨æ‰‹å®ç°KVO"></a>è‡ªå·±åŠ¨æ‰‹å®ç°KVO</h2><p>åˆåˆ°äº†æ¿€åŠ¨äººå¿ƒçš„<code>coding</code>ç¯èŠ‚ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†è¿™äº›å…·ä½“å®è·µæ­¥éª¤ï¼Œä½•ä¸æ¥è‡ªå·±åˆ›é€ ä¸€ä¸ª<code>custom KVO</code>ï¼Ÿ</p>
<p>å›æƒ³ä¸€ä¸‹è‡ªå·±å¹³æ—¶ä½¿ç”¨<code>KVO</code>çš„è¿‡ç¨‹ï¼Œæœ€è›‹ç–¼çš„å°±æ˜¯ä¸æ”¯æŒ<code>block</code>ã€‚æœ¬äººæ˜¯ä¸ªé‡åº¦<code>block</code>æ‚£è€…ï¼Œ<code>KVO</code>ä¸æ”¯æŒ<code>block</code>å¯¹æˆ‘æ¥è¯´ç®€ç›´ä¸èƒ½å¿ã€‚äºæ˜¯ğŸ‘‡è¿™ä¸ª<code>coolKVO</code>è®¾è®¡å‡ºæ¥å°±æ˜¯ä¸ºäº†æ”¯æŒ<code>block</code>çš„</p>
<p>å»ºç«‹ä¸€ä¸ªå«åš<code>ACoolCustom_KVO</code>çš„<code>category</code>ï¼ˆğŸ˜“ä¸ºä»€ä¹ˆæ„Ÿè§‰ä¸­äºŒæ„Ÿçˆ†æ£šï¼‰:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^ZLObservingBlock)(<span class="keyword">id</span> observedObject, <span class="keyword">id</span> oldValue, <span class="keyword">id</span> newValue);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">ACoolCustom_KVO</span>)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *    è‡ªå®šä¹‰æ·»åŠ è§‚å¯Ÿè€…</div><div class="line"> *</div><div class="line"> *    @param oberserver è§‚å¯Ÿè€…</div><div class="line"> *    @param keyPath    è¦è§‚å¯Ÿçš„å±æ€§</div><div class="line"> *    @param block      è‡ªå®šä¹‰å›è°ƒ</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)zl_addObserver:(<span class="keyword">id</span>)oberserver</div><div class="line">           forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">                 block:(ZLObservingBlock)block;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *    ç§»é™¤è§‚å¯Ÿè€…</div><div class="line"> *</div><div class="line"> *    @param obserbe è§‚å¯Ÿè€…</div><div class="line"> *    @param keyPath keyPath</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)zl_removeObserver:(<span class="keyword">id</span>)obserbe</div><div class="line">                  keyPath:(<span class="built_in">NSString</span> *)keyPath;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>å…·ä½“å®ç°:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"NSObject+ACoolCustom_KVO.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* kObjectPropertyKey = <span class="string">"kObjectPropertyKey"</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^ZLObservingBlock)(<span class="keyword">id</span> observedObject, <span class="keyword">id</span> oldValue, <span class="keyword">id</span> newValue);</div><div class="line"></div><div class="line"><span class="comment">//é‡å†™çš„classæ–¹æ³•</span></div><div class="line">Class new_class(<span class="keyword">id</span> <span class="keyword">self</span>)&#123;</div><div class="line"></div><div class="line"></div><div class="line">    Class <span class="keyword">class</span> = object_getClass(<span class="keyword">self</span>);</div><div class="line">    Class superClass = class_getSuperclass(<span class="keyword">class</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> superClass;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">NSString</span> * setterForGetter(<span class="built_in">NSString</span> *key)&#123;</div><div class="line">    <span class="built_in">NSString</span> *str = [key capitalizedString];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *setterSEL = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@:"</span>,str];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> setterSEL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> kvo_setter (<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="keyword">id</span> newValue)&#123;</div><div class="line">    <span class="comment">//è·å–æ—§å€¼</span></div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> objc_super superclass = &#123;</div><div class="line">        .receiver = <span class="keyword">self</span>,</div><div class="line">        .super_class = class_getSuperclass(object_getClass(<span class="keyword">self</span>))</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ©ç”¨å‡½æ•°æŒ‡é’ˆå¼ºåˆ¶è½¬æ¢</span></div><div class="line">    <span class="keyword">void</span> (*objc_msgSendSuperCasted)(<span class="keyword">void</span> *, SEL, <span class="keyword">id</span>) = (<span class="keyword">void</span> *)objc_msgSendSuper;</div><div class="line">    </div><div class="line">    </div><div class="line">    objc_msgSendSuperCasted(&amp;superclass, _cmd, newValue);</div><div class="line">    </div><div class="line"></div><div class="line">    ZLObservingBlock block = objc_getAssociatedObject(<span class="keyword">self</span>, kObjectPropertyKey);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">        block(<span class="keyword">self</span>, <span class="literal">nil</span>, newValue);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Class setupKVO_Class(<span class="keyword">id</span> <span class="keyword">self</span>, <span class="built_in">NSString</span> *kvoClassName, SEL setterSel, ZLObservingBlock block)&#123;</div><div class="line">    Class originalClass = object_getClass(<span class="keyword">self</span>);</div><div class="line">    <span class="comment">//åˆ›å»ºä¸­é—´ç±» å¹¶ä½¿å…¶ç»§æ‰¿è¢«ç›‘å¬çš„ç±»</span></div><div class="line">    Class kvoClass = objc_allocateClassPair(originalClass, kvoClassName.UTF8String, <span class="number">0</span>);</div><div class="line">    <span class="comment">//å‘runtimeåŠ¨æ€æ³¨å†Œç±»</span></div><div class="line">    objc_registerClassPair(kvoClass);</div><div class="line">    object_setClass(<span class="keyword">self</span>, kvoClass);</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//æ›¿æ¢è¢«ç›‘å¬å¯¹è±¡çš„classæ–¹æ³•...</span></div><div class="line">    </div><div class="line">    <span class="comment">//åŸå§‹ç±»çš„classæ–¹æ³•çš„å®ç°</span></div><div class="line">    <span class="comment">//åŸå§‹ç±»çš„classæ–¹æ³•çš„å‚æ•°ç­‰ä¿¡æ¯</span></div><div class="line">    Method clazzMethod = class_getInstanceMethod(originalClass, <span class="keyword">@selector</span>(<span class="keyword">class</span>));</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types = method_getTypeEncoding(clazzMethod);</div><div class="line">    class_addMethod(kvoClass, <span class="keyword">@selector</span>(<span class="keyword">class</span>), (IMP)new_class, types);</div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//é‡å†™ä¸­é—´ç±»çš„setteræ–¹æ³•</span></div><div class="line">    Method setterMethod = class_getInstanceMethod(originalClass, setterSel);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *setter_types = method_getTypeEncoding(setterMethod);</div><div class="line">    class_replaceMethod(kvoClass, setterSel, (IMP)kvo_setter, setter_types);</div><div class="line">    </div><div class="line"></div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, kObjectPropertyKey ,block, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> kvoClass;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">ACoolCustom_KVO</span>)</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)zl_addObserver:(<span class="keyword">id</span>)oberserver forKeyPath:(<span class="built_in">NSString</span> *)keyPath block:(ZLObservingBlock)block&#123;</div><div class="line">    <span class="comment">//å‚æ•°æ˜¯å¦åˆæ³•</span></div><div class="line">    <span class="keyword">if</span> (!oberserver || !keyPath || !keyPath.length || !block) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    SEL  setterSel = <span class="built_in">NSSelectorFromString</span>(setterForGetter(keyPath));</div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> respondsToSelector:setterSel]) &#123;</div><div class="line">        <span class="comment">//æ ¡éªŒè¢«è§‚å¯Ÿè€…æ˜¯å¦æœ‰è¿™ä¸ªsetteræ–¹æ³•</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//æ ¡éªŒå®Œæ¯• å¼€å§‹è®¾ç½®kvo</span></div><div class="line">    </div><div class="line">    <span class="comment">//è·å–å½“å‰ç±»çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡</span></div><div class="line">    Class kvoClass = object_getClass(<span class="keyword">self</span>);</div><div class="line">    <span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(kvoClass);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (![className hasPrefix:<span class="string">@"ACoolCustom_KVOPrefix"</span>]) &#123;<span class="comment">//æœªç”Ÿæˆè¿‡ä¸­é—´ç±»</span></div><div class="line">        <span class="built_in">NSString</span> *originalClassName = <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSString</span> *kvoClassName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%@"</span>,<span class="string">@"ACoolCustom_KVOPrefix"</span>,originalClassName];</div><div class="line"></div><div class="line">        setupKVO_Class(<span class="keyword">self</span>, kvoClassName,setterSel,block);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>ç›¸å…³çš„æ³¨é‡Šéƒ½å·²ç»å†™åœ¨é‡Œé¢å•¦ï¼Œè‡ªå·±ä¹Ÿæ˜¯æŠ˜è…¾äº†å°½ä¸€ä¸‹åˆçš„æ—¶é—´æ‰æå®šã€‚å…³äº<code>remove</code>çš„æ–¹æ³•å¤§å®¶å¯ä»¥è‡ªå·±å®è·µä¸‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±ä¸åœ¨æ­¤ç»™å‡ºäº†ã€‚è°¢è°¢è§‚èµ~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>è¯·æ¯å’–å•¡å–ï¼Ÿ</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://i1.buimg.com/572363/b21593e5f65ea204.jpg" alt="Zheng Li WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://i1.buimg.com/572363/7caac38df4844f66.jpg" alt="Zheng Li Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/21/èŠèŠruntimeé‚£äº›äº‹/" rel="next" title="èŠèŠruntimeé‚£äº›äº‹">
                <i class="fa fa-chevron-left"></i> èŠèŠruntimeé‚£äº›äº‹
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://tva3.sinaimg.cn/crop.0.0.511.511.180/006pqpL6jw8f4z97xky5nj30e70e8aai.jpg"
               alt="Zheng Li" />
          <p class="site-author-name" itemprop="name">Zheng Li</p>
          <p class="site-description motion-element" itemprop="description">iOSå¼€å‘èœé¸¡ï¼ŒåŠªåŠ›æé«˜è‡ªæˆ‘ä¸­ã€‚</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO-Key-Value-observingï¼‰"><span class="nav-number">2.</span> <span class="nav-text">KVO(Key-Value observingï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVOå®ç°åŸç†"><span class="nav-number">3.</span> <span class="nav-text">KVOå®ç°åŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è‡ªå·±åŠ¨æ‰‹å®ç°KVO"><span class="nav-number">4.</span> <span class="nav-text">è‡ªå·±åŠ¨æ‰‹å®ç°KVO</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zheng Li</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("28Bi52ufQCnrlpfv4vbx8JEG-gzGzoHsz", "1cAbB9JCSijqEURfv3Pa9uYd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
